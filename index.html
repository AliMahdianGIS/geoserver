<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Cambridge Permeable Surface Layer - WMTS Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load Calcite components from CDN -->
    <script type="module" src="https://js.arcgis.com/calcite-components/3.2.1/calcite.esm.js"></script>

    <!-- Load the ArcGIS Maps SDK for JavaScript from CDN -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/dark/main.css" />
    <script src="https://js.arcgis.com/4.33/"></script>

    <!-- Load Map components from CDN-->
    <script type="module" src="https://js.arcgis.com/4.33/map-components/"></script>

    <style>
      .map-container {
        height: 80vh;
        width: 100%;
      }
      .full-map {
        height: 100vh;
        width: 100%;
      }
    </style>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-md p-4">
      <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-gray-800">Cambridge, Canada - Permeable Surface Layer</h1>
        <p class="text-gray-600 mt-2">WMTS layer from GeoServer displaying permeable surface data</p>
      </div>
    </div>

    <!-- Map Container -->
    <div class="p-4">
      <div class="container mx-auto">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <!-- Map Controls Header -->
          <div class="bg-gray-50 p-4 border-b">
            <div class="flex justify-between items-center">
              <h2 class="text-xl font-semibold text-gray-700">Map View</h2>
              <div class="flex space-x-2">
                <button 
                  id="fullscreenBtn" 
                  class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                  Toggle Fullscreen
                </button>
                <button 
                  id="layerToggleBtn" 
                  class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                  Toggle Layer
                </button>
              </div>
            </div>
          </div>
          
          <!-- Map -->
          <div id="mapContainer" class="calcite-mode-dark map-container">
            <arcgis-map id="mapView" zoom="12" center="-80.3, 43.3" class="w-full h-full">
              <arcgis-zoom position="top-left"></arcgis-zoom>
              <arcgis-expand position="top-right">
                <arcgis-layer-list></arcgis-layer-list>
              </arcgis-expand>
              <arcgis-expand position="bottom-left">
                <arcgis-legend></arcgis-legend>
              </arcgis-expand>
            </arcgis-map>
          </div>
        </div>
      </div>
    </div>

    <!-- Layer Information Panel -->
    <div class="p-4">
      <div class="container mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-semibold text-gray-700 mb-4">Layer Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-medium text-gray-600">Layer Name:</h4>
              <p class="text-gray-800">rdt:permeable</p>
            </div>
            <div>
              <h4 class="font-medium text-gray-600">Format:</h4>
              <p class="text-gray-800">PNG</p>
            </div>
            <div>
              <h4 class="font-medium text-gray-600">Coordinate System:</h4>
              <p class="text-gray-800">EPSG:4326 (WGS84)</p>
            </div>
            <div>
              <h4 class="font-medium text-gray-600">Service Type:</h4>
              <p class="text-gray-800">WMTS</p>
            </div>
          </div>
          <div class="mt-4">
            <h4 class="font-medium text-gray-600">GeoServer URL:</h4>
            <p class="text-gray-800 break-all">http://localhost:8081/DigitalTwin/rdt/gwc/service/wmts</p>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      let mapInitialized = false;
      let wmtsLayer = null;

      // Initialize the map when page loads
      document.addEventListener('DOMContentLoaded', async () => {
        await initializeMap();
        mapInitialized = true;
      });

      // Fullscreen toggle
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      const mapContainer = document.getElementById('mapContainer');
      let isFullscreen = false;

      fullscreenBtn.addEventListener('click', () => {
        if (!isFullscreen) {
          mapContainer.classList.remove('map-container');
          mapContainer.classList.add('full-map', 'fixed', 'top-0', 'left-0', 'z-50');
          fullscreenBtn.textContent = 'Exit Fullscreen';
          isFullscreen = true;
        } else {
          mapContainer.classList.remove('full-map', 'fixed', 'top-0', 'left-0', 'z-50');
          mapContainer.classList.add('map-container');
          fullscreenBtn.textContent = 'Toggle Fullscreen';
          isFullscreen = false;
        }
      });

      // Layer toggle
      const layerToggleBtn = document.getElementById('layerToggleBtn');
      layerToggleBtn.addEventListener('click', () => {
        if (wmtsLayer) {
          wmtsLayer.visible = !wmtsLayer.visible;
          layerToggleBtn.textContent = wmtsLayer.visible ? 'Hide Layer' : 'Show Layer';
        }
      });

      // Initialize the map with WMTS layer
      async function initializeMap() {
        try {
          const [Map, WMTSLayer, TileInfo, Point, SpatialReference] = await $arcgis.import([
            "@arcgis/core/Map.js",
            "@arcgis/core/layers/WMTSLayer.js",
            "@arcgis/core/layers/support/TileInfo.js",
            "@arcgis/core/geometry/Point.js",
            "@arcgis/core/geometry/SpatialReference.js"
          ]);

          const viewElement = document.querySelector("arcgis-map");
          
          // Create WMTS layer
          wmtsLayer = new WMTSLayer({
            url: "http://localhost:8081/DigitalTwin/rdt/gwc/service/wmts",
            activeLayer: {
              id: "rdt:permeable"
            },
            serviceMode: "RESTful",
            title: "Cambridge Permeable Surfaces",
            opacity: 0.8
          });

          // Create the map
          viewElement.map = new Map({
            basemap: "streets-navigation-vector",
            layers: [wmtsLayer]
          });

          // Set the view to Cambridge, Canada
          await viewElement.when();
          const view = viewElement.view;
          
          // Center on Cambridge, Canada
          view.center = new Point({
            longitude: -80.3163,
            latitude: 43.3616,
            spatialReference: SpatialReference.WGS84
          });
          
          view.zoom = 12;

          console.log("Map initialized successfully with WMTS layer");
          console.log("WMTS Layer:", wmtsLayer);

        } catch (error) {
          console.error("Error initializing map:", error);
          
          // Show error message to user
          const mapContainer = document.getElementById('mapContainer');
          mapContainer.innerHTML = `
            <div class="flex items-center justify-center h-full bg-red-50">
              <div class="text-center p-8">
                <h3 class="text-xl font-semibold text-red-700 mb-4">Error Loading Map</h3>
                <p class="text-red-600 mb-4">Failed to load the WMTS layer. Please check:</p>
                <ul class="text-left text-red-600 space-y-2">
                  <li>• GeoServer is running on localhost:8081</li>
                  <li>• The layer 'rdt:permeable' exists</li>
                  <li>• WMTS service is enabled</li>
                  <li>• CORS is properly configured</li>
                </ul>
                <p class="text-sm text-gray-600 mt-4">Error: ${error.message}</p>
              </div>
            </div>
          `;
        }
      }
    </script>
  </body>
</html>